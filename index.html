<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1">
    <title>VR Video Experience</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <!-- Keeping your existing styles and adding new ones -->
    <style>
        /* Previous styles remain unchanged */
        /* Adding new styles for controls */
        .vr-controls-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 150px;
        }
        
        .volume-slider {
            width: 100px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }
        
        .volume-fill {
            height: 100%;
            background: #00FF9D;
            border-radius: 2px;
            width: 100%;
        }
        
        .fullscreen-button {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Previous HTML structure remains largely unchanged -->
    <div class="initialUI">
        <h1>VR Video Experience</h1>
        <video id="preview" 
               src="https://storage.googleapis.com/vrvideo1/video1/VR%20360%20The%20Beast%20World's%20Longest%20Wooden%20Roller%20Coaster%20POV%20Kings%20Island%20Ohio.mp4" 
               controls 
               preload="metadata"
               crossorigin="anonymous"
               playsinline>
        </video>
        <button onclick="enterVR()">Enter VR Mode</button>
    </div>

    <div class="loading-indicator" id="loadingIndicator">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading VR Experience...</div>
        <div class="loading-status"></div>
    </div>

    <a-scene id="vrScene" vr-mode-ui="enabled: false" embedded style="display: none;">
        <a-assets timeout="60000">
            <video id="vrVideo" 
                   src="https://storage.googleapis.com/vrvideo1/video1/VR%20360%20The%20Beast%20World's%20Longest%20Wooden%20Roller%20Coaster%20POV%20Kings%20Island%20Ohio.mp4"
                   preload="auto"
                   crossorigin="anonymous"
                   playsinline
                   webkit-playsinline
                   loop>
            </video>
        </a-assets>

        <a-videosphere id="videoSphere" 
                      src="#vrVideo"
                      rotation="0 0 0"
                      segments-height="96"
                      segments-width="96"
                      radius="10000"
                      material="shader: flat; side: back; npot: true"
                      play="true">
        </a-videosphere>

        <a-entity id="cameraRig" position="0 1.6 0">
            <a-camera id="camera"
                      look-controls="reverseMouseDrag: true; 
                                    touchEnabled: true; 
                                    magicWindowTrackingEnabled: true;
                                    pointerLockEnabled: false"
                      wasd-controls="enabled: false">
                <a-entity id="gazeCursor"
                          cursor="fuse: true; fuseTimeout: 1500"
                          position="0 0 -1"
                          geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                          material="color: #FFFFFF; shader: flat; opacity: 0.9">
                </a-entity>
            </a-camera>
        </a-entity>
    </a-scene>

    <div id="vrInterface" class="vr-interface">
        <div class="vr-cursor" id="vrCursor"></div>
        
        <div class="top-controls">
            <button class="top-button clickable" id="exitBtn">
                <i class="material-icons-round">close</i>
            </button>
            <button class="top-button clickable fullscreen-button" id="fullscreenBtn">
                <i class="material-icons-round">fullscreen</i>
            </button>
        </div>

        <div class="vr-controls-panel" id="vrControlsPanel">
            <div class="video-title">VR 360Â° Roller Coaster Experience</div>
            <div class="controls-row">
                <button class="vr-button clickable" id="rewindBtn">
                    <i class="material-icons-round">replay_10</i>
                </button>
                <button class="vr-button clickable" id="playPauseBtn">
                    <i class="material-icons-round">play_arrow</i>
                </button>
                <button class="vr-button clickable" id="forwardBtn">
                    <i class="material-icons-round">forward_10</i>
                </button>
                
                <div class="vr-progress-container">
                    <div class="vr-progress-bar clickable" id="progressBar">
                        <div class="vr-progress-fill" id="progressFill"></div>
                    </div>
                    <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
                </div>
                
                <div class="volume-container">
                    <button class="vr-button clickable" id="muteBtn">
                        <i class="material-icons-round">volume_up</i>
                    </button>
                    <div class="volume-slider clickable" id="volumeSlider">
                        <div class="volume-fill" id="volumeFill"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="error-message"></div>
    <div id="vrTouchOverlay" class="vr-touch-overlay"></div>

    <script>
        const globals = {
            vrVideo: null,
            vrScene: null,
            vrInterface: null,
            isVRMode: false,
            isInitialized: false,
            isFullscreen: false,
            controlsVisible: true,
            lastInteraction: 0
        };

        const utils = {
            showLoading: function() {
                document.getElementById('loadingIndicator').classList.add('visible');
            },
            hideLoading: function() {
                document.getElementById('loadingIndicator').classList.remove('visible');
            },
            updateLoadingStatus: function(message) {
                document.querySelector('.loading-status').textContent = message;
            },
            showError: function(message) {
                const errorElement = document.getElementById('error-message');
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => errorElement.style.display = 'none', 5000);
            },
            formatTime: function(seconds) {
                const minutes = Math.floor(seconds / 60);
                seconds = Math.floor(seconds % 60);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        };

        async function initialize() {
            try {
                globals.vrVideo = document.getElementById('vrVideo');
                globals.vrScene = document.getElementById('vrScene');
                globals.vrInterface = document.getElementById('vrInterface');

                if (!globals.vrVideo || !globals.vrScene || !globals.vrInterface) {
                    throw new Error('Required elements not found');
                }

                globals.vrVideo.addEventListener('loadedmetadata', () => {
                    globals.isInitialized = true;
                    updateVolumeUI();
                });

                if (navigator.xr) {
                    const supported = await navigator.xr.isSessionSupported('immersive-vr');
                    if (!supported) {
                        utils.showError('VR not supported on this device');
                    }
                }

                setupControls();
            } catch (error) {
                utils.showError('Initialization failed: ' + error.message);
            }
        }

        async function enterVR() {
            try {
                utils.showLoading();
                document.querySelector('.initialUI').style.display = 'none';
                globals.vrScene.style.display = 'block';

                await globals.vrScene.enterVR();
                globals.isVRMode = true;

                await globals.vrVideo.play();
                document.querySelector('#playPauseBtn i').textContent = 'pause';
                showControls();
                updateProgress();

                utils.hideLoading();
            } catch (error) {
                utils.showError('Failed to enter VR: ' + error.message);
                document.querySelector('.initialUI').style.display = 'block';
                globals.vrScene.style.display = 'none';
            }
        }

        function setupControls() {
            const controls = {
                playPause: document.getElementById('playPauseBtn'),
                rewind: document.getElementById('rewindBtn'),
                forward: document.getElementById('forwardBtn'),
                exit: document.getElementById('exitBtn'),
                fullscreen: document.getElementById('fullscreenBtn'),
                mute: document.getElementById('muteBtn'),
                progress: document.getElementById('progressBar'),
                volume: document.getElementById('volumeSlider')
            };

            controls.playPause?.addEventListener('click', togglePlay);
            controls.rewind?.addEventListener('click', () => {
                globals.vrVideo.currentTime = Math.max(0, globals.vrVideo.currentTime - 10);
            });
            controls.forward?.addEventListener('click', () => {
                globals.vrVideo.currentTime = Math.min(globals.vrVideo.duration, globals.vrVideo.currentTime + 10);
            });
            controls.exit?.addEventListener('click', exitVR);
            controls.fullscreen?.addEventListener('click', toggleFullscreen);
            controls.mute?.addEventListener('click', toggleMute);

            controls.progress?.addEventListener('click', (e) => {
                const rect = controls.progress.getBoundingClientRect();
                const ratio = (e.clientX - rect.left) / rect.width;
                globals.vrVideo.currentTime = ratio * globals.vrVideo.duration;
            });

            controls.volume?.addEventListener('click', (e) => {
                const rect = controls.volume.getBoundingClientRect();
                const ratio = (e.clientX - rect.left) / rect.width;
                globals.vrVideo.volume = Math.max(0, Math.min(1, ratio));
                updateVolumeUI();
            });

            // Touch events
            controls.progress?.addEventListener('touchstart', handleTouchSeek);
            controls.progress?.addEventListener('touchmove', handleTouchSeek);
            controls.volume?.addEventListener('touchstart', handleTouchVolume);
            controls.volume?.addEventListener('touchmove', handleTouchVolume);
        }

        function handleTouchSeek(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const progressBar = document.getElementById('progressBar');
            const rect = progressBar.getBoundingClientRect();
            const ratio = (touch.clientX - rect.left) / rect.width;
            globals.vrVideo.currentTime = ratio * globals.vrVideo.duration;
        }

        function handleTouchVolume(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const volumeSlider = document.getElementById('volumeSlider');
            const rect = volumeSlider.getBoundingClientRect();
            const ratio = (touch.clientX - rect.left) / rect.width;
            globals.vrVideo.volume = Math.max(0, Math.min(1, ratio));
            updateVolumeUI();
        }

        function togglePlay() {
            if (globals.vrVideo.paused) {
                globals.vrVideo.play();
                document.querySelector('#playPauseBtn i').textContent = 'pause';
            } else {
                globals.vrVideo.pause();
                document.querySelector('#playPauseBtn i').textContent = 'play_arrow';
            }
        }

        function toggleMute() {
            globals.vrVideo.muted = !globals.vrVideo.muted;
            const muteIcon = document.querySelector('#muteBtn i');
            muteIcon.textContent = globals.vrVideo.muted ? 'volume_off' : 'volume_up';
            updateVolumeUI();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                globals.isFullscreen = true;
                document.querySelector('#fullscreenBtn i').textContent = 'fullscreen_exit';
            } else {
                document.exitFullscreen();
                globals.isFullscreen = false;
                document.querySelector('#fullscreenBtn i').textContent = 'fullscreen';
            }
        }

        function updateProgress() {
            if (!globals.vrVideo || !globals.isVRMode) return;

            const progressFill = document.getElementById('progressFill');
            const timeDisplay = document.getElementById('timeDisplay');
            const progress = (globals.vrVideo.currentTime / globals.vrVideo.duration) * 100;
            
            progressFill.style.width = `${progress}%`;
            timeDisplay.textContent = `${utils.formatTime(globals.vrVideo.currentTime)} / ${utils.formatTime(globals.vrVideo.duration)}`;
            
            requestAnimationFrame(updateProgress);
        }

        function updateVolumeUI() {
            const volumeFill = document.getElementById('volumeFill');
            const muteIcon = document.querySelector('#muteBtn i');
            const volume = globals.vrVideo.muted ? 0 : globals.vrVideo.volume;
            volumeFill.style.width = `${volume * 100}%`;
            muteIcon.textContent = globals.vrVideo.muted || volume === 0 ? 'volume_off' : 'volume_up';
        }

        function showControls() {
            const controlsPanel = document.getElementById('vrControlsPanel');
            controlsPanel.classList.add('visible');
            globals.controlsVisible = true;
            globals.lastInteraction = Date.now();
            setTimeout(hideControls, 5000); // Auto-hide after 5 seconds
        }

        function hideControls() {
            if (Date.now() - globals.lastInteraction >= 5000) {
                const controlsPanel = document.getElementById('vrControlsPanel');
                controlsPanel.classList.remove('visible');
                globals.controlsVisible = false;
            }
        }

        function exitVR() {
            if (!globals.isVRMode) return;
            globals.vrScene.exitVR();
            globals.isVRMode = false;
            globals.vrVideo.pause();
            document.querySelector('.initialUI').style.display = 'block';
            globals.vrScene.style.display = 'none';
        }

        // UI follows camera
        function updateUIPosition() {
            if (!globals.isVRMode) return;
            
            const camera = document.getElementById('camera');
            const controlsPanel = document.getElementById('vrControlsPanel');
            const rotation = camera.getAttribute('rotation');
            const position = camera.getAttribute('position');

            controlsPanel.style.transform = `translate(-50%, 0) rotateY(${rotation.y}deg)`;
            requestAnimationFrame(updateUIPosition);
        }

        // Event Listeners
        window.addEventListener('load', initialize);
        globals.vrScene?.addEventListener('enter-vr', () => {
            requestAnimationFrame(updateUIPosition);
        });

        // Make functions globally available
        window.enterVR = enterVR;
    </script>
</body>
</html>