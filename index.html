<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1" />
  <title>VR Video Experience</title>
  <link rel="icon" type="image/x-icon" href="./favicon.ico" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: 'Arial', sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      position: fixed;
    }

    .initialUI {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 1000;
      padding: 20px;
      background: rgba(34, 34, 34, 0.95);
      border-radius: 15px;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      max-width: 90%;
      width: 400px;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .initialUI.hidden {
      opacity: 0;
      visibility: hidden;
    }
    .initialUI h1 {
      font-size: 1.5em;
      margin-bottom: 15px;
    }
    .initialUI button {
      background: linear-gradient(45deg, #6b48ff, #00ddeb);
      padding: 12px 30px;
      border: none;
      border-radius: 25px;
      font-size: 1.2em;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      box-shadow: 0 5px 15px rgba(107, 72, 255, 0.4);
      width: 100%;
      max-width: 200px;
    }
    .initialUI button:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(107, 72, 255, 0.6);
    }

    .a-enter-vr-button {
      bottom: 20px !important;
      right: 20px !important;
    }
    
    a-scene {
      width: 100vw;
      height: 100vh;
      display: none;
    }

    .mini-aframe {
      width: 100%;
      height: 200px; 
      border-radius: 10px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    #previewPlayOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
      cursor: pointer;
      border-radius: 10px;
      transition: background 0.3s;
    }
    #previewPlayOverlay.hidden {
      display: none;
    }
    #previewPlayOverlay:hover {
      background: rgba(0, 0, 0, 0.7);
    }
    .play-icon {
      font-size: 48px;
      color: #fff;
      text-shadow: 0 0 10px rgba(0, 0, 10, 0.5);
    }
  </style>
</head>
<body>
  <div class="initialUI" id="initialUI">
    <h1>VR Video Experience (360 Preview)</h1>
    
    <div class="mini-aframe">
      <a-scene
        id="previewScene"
        embedded
        vr-mode-ui="enabled: false"
        style="width: 100%; height: 100%;"
        cursor="rayOrigin: mouse"
      >
        <a-videosphere
          src="#previewVideoSource"
          rotation="0 180 0"
        ></a-videosphere>
        <a-entity camera look-controls></a-entity>
      </a-scene>
      <div id="previewPlayOverlay">
        <span class="material-icons-round play-icon">play_circle_filled</span>
      </div>
    </div>

    <button id="enterVRBtn">Enter VR mode</button>
  </div>

  <a-scene
    id="vrScene"
    embedded
    vr-mode-ui="enabled: true"
    style="height: 100vh; width: 100vw; background-color: black;"
  >
    <a-sky color="#000"></a-sky>

    <a-videosphere
      id="videoSphere"
      src="#vrVideo"
      rotation="0 180 0"
    ></a-videosphere>

    <a-entity
      id="cameraRig"
      position="0 1.6 0"
    >
      <a-entity
        camera
        look-controls
        wasd-controls-enabled="false"
        position="0 0 0"
      >
        <a-cursor color="#FFF" raycaster="objects: .vr-control; far: 5; showLine: false"></a-cursor>
      </a-entity>
    </a-entity>

    <a-entity
      id="vr3DControls"
      position="0 1.6 -1.8"
      rotation="0 0 0"
      visible="false"
    >
      <a-plane
        width="2.2"
        height="0.7"
        color="#333"
        opacity="0.9"
        position="0 0 0"
        shadow
        geometry="height: 0.7; width: 2.2; buffer: false"
        material="shader: flat"
      ></a-plane>

      <a-entity
        id="recenterBtn3D"
        geometry="primitive: circle; radius: 0.2"
        material="color: #6b48ff; shader: flat"
        position="-0.8 0 0.01"
        class="vr-control"
      >
        <a-text value="CENTER" align="center" width="1.5" color="#FFF"></a-text>
      </a-entity>

      <a-entity
        id="rewindBtn3D"
        geometry="primitive: circle; radius: 0.2"
        material="color: #6b48ff; shader: flat"
        position="-0.4 0 0.01"
        class="vr-control"
      >
        <a-text value="<<" align="center" width="1.5" color="#FFF"></a-text>
      </a-entity>

      <a-entity
        id="playPauseBtn3D"
        geometry="primitive: circle; radius: 0.25"
        material="color: #00ddeb; shader: flat"
        position="0 0 0.01"
        class="vr-control"
      >
        <a-text id="playPauseText3D" value="PLAY" align="center" width="2" color="#FFF"></a-text>
      </a-entity>

      <a-entity
        id="forwardBtn3D"
        geometry="primitive: circle; radius: 0.2"
        material="color: #6b48ff; shader: flat"
        position="0.4 0 0.01"
        class="vr-control"
      >
        <a-text value=">>" align="center" width="1.5" color="#FFF"></a-text>
      </a-entity>

      <a-entity
        id="exitBtn3D"
        geometry="primitive: circle; radius: 0.2"
        material="color: #FF4848; shader: flat"
        position="0.8 0 0.01"
        class="vr-control"
      >
        <a-text value="EXIT" align="center" width="1.5" color="#FFF"></a-text>
      </a-entity>
      
      <a-entity
        id="volumeUpBtn3D"
        geometry="primitive: circle; radius: 0.15"
        material="color: #48FF8A; shader: flat"
        position="0 0.45 0.01"
        class="vr-control"
      >
        <a-text value="VOL +" align="center" width="1" color="#000"></a-text>
      </a-entity>
      
      <a-entity
        id="volumeDownBtn3D"
        geometry="primitive: circle; radius: 0.15"
        material="color: #FF4848; shader: flat"
        position="0 -0.45 0.01"
        class="vr-control"
      >
        <a-text value="VOL -" align="center" width="1" color="#000"></a-text>
      </a-entity>
    </a-entity>
  </a-scene>

  <video
    id="previewVideoSource"
    crossorigin="anonymous"
    playsinline
    webkit-playsinline
    preload="auto"
    muted
    loop
    style="display:none"
    src="falling.mp4"
  ></video>

  <video
    id="vrVideo"
    crossorigin="anonymous"
    playsinline
    webkit-playsinline
    preload="auto"
    muted
    style="display:none"
    src="falling.mp4"
  ></video>

  <script>
    const enterVRBtn = document.getElementById('enterVRBtn');
    const initialUI = document.getElementById('initialUI');
    const vrScene = document.getElementById('vrScene');
    const previewScene = document.getElementById('previewScene');
    const vrVideo = document.getElementById('vrVideo');
    const previewVideoSource = document.getElementById('previewVideoSource');
    const cameraRig = document.getElementById('cameraRig');
    const vr3DControls = document.getElementById('vr3DControls');
    const previewPlayOverlay = document.getElementById('previewPlayOverlay');

    const playPauseBtn3D = document.getElementById('playPauseBtn3D');
    const rewindBtn3D = document.getElementById('rewindBtn3D');
    const forwardBtn3D = document.getElementById('forwardBtn3D');
    const exitBtn3D = document.getElementById('exitBtn3D');
    const recenterBtn3D = document.getElementById('recenterBtn3D');
    const volumeUpBtn3D = document.getElementById('volumeUpBtn3D');
    const volumeDownBtn3D = document.getElementById('volumeDownBtn3D');
    const playPauseText3D = document.getElementById('playPauseText3D');

    function updatePlayPauseText3D() {
      playPauseText3D.setAttribute('value', vrVideo.paused ? 'PLAY' : 'PAUSE');
    }

    function togglePlayPause() {
      if (vrVideo.paused) {
        vrVideo.play();
      } else {
        vrVideo.pause();
      }
      updatePlayPauseText3D();
    }

    function rewind10() {
      vrVideo.currentTime = Math.max(0, vrVideo.currentTime - 10);
    }

    function forward10() {
      vrVideo.currentTime = Math.min(vrVideo.duration, vrVideo.currentTime + 10);
    }

    function recenterView() {
      cameraRig.setAttribute('rotation', '0 0 0');
    }

    function setVolume(change) {
      let newVolume = vrVideo.volume + change;
      newVolume = Math.min(Math.max(0, newVolume), 1);
      vrVideo.volume = newVolume;
      vrVideo.muted = (newVolume === 0);
    }

    function startPreview() {
        previewVideoSource.play().then(() => {
            previewPlayOverlay.classList.add('hidden');
        }).catch(e => {
            console.error("Preview video playback blocked:", e);
            previewPlayOverlay.classList.remove('hidden');
        });
    }

    function stopPreview() {
        previewVideoSource.pause();
        previewVideoSource.currentTime = 0;
        previewPlayOverlay.classList.remove('hidden'); 
    }

    function enterVR() {
      stopPreview();
      initialUI.classList.add('hidden');
      vrScene.style.display = 'block';

      vrVideo.muted = false;
      vrVideo.currentTime = 0;
      vrVideo.play().then(() => {
        vrScene.enterVR();
      }).catch((err) => {
        console.error('Video Playback Failed on Enter VR. Permission or source issue.', err);
        alert('VR Launch Failed. Check browser permissions (gyroscope/VR mode) or use the headset icon.');
        initialUI.classList.remove('hidden');
        vrScene.style.display = 'none';
        startPreview(); 
      });
    }

    function exitVR() {
      vrVideo.pause();
      vrVideo.currentTime = 0;
      
      if (vrScene.is('vr-mode')) {
        vrScene.exitVR();
      }
      
      initialUI.classList.remove('hidden');
      vrScene.style.display = 'none';
      startPreview();
    }

    // Initialize/Setup Handlers
    
    // Attempt to start preview video playback when the user taps the overlay
    previewPlayOverlay.addEventListener('click', startPreview);
    previewPlayOverlay.addEventListener('touchend', startPreview);

    vrScene.addEventListener('loaded', () => {
        vrVideo.pause();
        vrVideo.muted = true;
    });

    // We start the preview when the mini-scene is ready, but it will be blocked until user interaction
    previewScene.addEventListener('loaded', () => {
        // Attempting to play immediately to load video assets, but browser will pause it.
        startPreview(); 
    });

    vrScene.addEventListener('enter-vr', () => {
      vr3DControls.setAttribute('visible', true);
      updatePlayPauseText3D();
    });

    vrScene.addEventListener('exit-vr', () => {
      vr3DControls.setAttribute('visible', false);
      startPreview();
    });

    ['click', 'touchend', 'pointerup'].forEach(evt => {
      enterVRBtn.addEventListener(evt, e => {
        e.preventDefault();
        enterVR();
      });
    });

    playPauseBtn3D.addEventListener('click', togglePlayPause);
    rewindBtn3D.addEventListener('click', rewind10);
    forwardBtn3D.addEventListener('click', forward10);
    recenterBtn3D.addEventListener('click', recenterView);
    exitBtn3D.addEventListener('click', exitVR);
    volumeUpBtn3D.addEventListener('click', () => setVolume(0.1));
    volumeDownBtn3D.addEventListener('click', () => setVolume(-0.1));

  </script>
</body>
</html>
