<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1">
    <title>VR Video Experience</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: fixed;
        }
        .initialUI {
            text-align: center;
            z-index: 1000;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            max-width: 320px;
            padding: 20px;
            box-sizing: border-box;
        }
        .initialUI video {
            width: 100%;
            height: auto;
            max-height: 240px;
            margin-bottom: 10px;
            background: #000;
        }
        .initialUI button {
            background: #a78bfa;
            color: #fff;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0 4px 8px rgb(0 0 0 / 30%);
            transition: background 0.3s;
            width: 100%;
            max-width: 280px;
        }
        .initialUI button:hover {
            background: #8b5cf6;
        }
        .vrControls {
            text-align: center;
            z-index: 1001;
            position: absolute;
            top: 20px;
            left: 20px;
        }
        #controlsPanel {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgb(0 0 0 / 70%);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
            min-width: 300px;
            transition: opacity 0.3s;
        }
        .control-group {
            margin: 10px 0;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .control-group:last-child {
            border-bottom: none;
        }
        .control-label {
            display: block;
            margin-bottom: 5px;
            color: #fff;
            font-size: 0.9em;
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin: 10px 0;
            cursor: pointer;
        }
        .progress-bar-fill {
            height: 100%;
            background: #a78bfa;
            border-radius: 2px;
            width: 0%;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .volume-slider {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            cursor: pointer;
        }
        .volume-fill {
            height: 100%;
            background: #a78bfa;
            border-radius: 2px;
            width: 100%;
        }
        .quality-select {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 4px;
            color: #fff;
            margin-top: 5px;
        }
        .speed-select {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 4px;
            color: #fff;
            margin-top: 5px;
        }
        .time-display {
            display: flex;
            justify-content: space-between;
            color: #fff;
            font-size: 0.8em;
            margin-top: 5px;
        }
        .control-button {
            background: none;
            border: none;
            color: #fff;
            padding: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: color 0.3s;
        }
        .control-button:hover {
            color: #a78bfa;
        }
        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .controls-title {
            color: #fff;
            font-size: 1.1em;
            margin: 0;
        }
        .close-controls {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
        }
        .quick-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 25px;
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .quick-controls.visible {
            opacity: 1;
        }
        .quick-control-button {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s;
        }
        .quick-control-button:hover {
            color: #a78bfa;
        }
        .a-canvas {
            height: 100vh;
            width: 100vw;
        }
        #error-message {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #fff;
            z-index: 1002;
            display: none;
            background: rgb(0 0 0 / 70%);
            padding: 15px;
            border-radius: 8px;
            max-width: 80%;
            text-align: center;
        }
        @media (orientation: landscape) {
            .initialUI {
                top: 50%;
                transform: translate(-50%, -50%);
            }
            .initialUI video {
                max-height: 40vh;
            }
        }
        .clickable {
            cursor: pointer;
        }
        #vrCursor {
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="initialUI">
        <h1>VR Video Experience</h1>
        <video id="smallVideoPlayer" src="https://storage.googleapis.com/vrvideo1/video1/VR%20360%20The%20Beast%20World's%20Longest%20Wooden%20Roller%20Coaster%20POV%20Kings%20Island%20Ohio.mp4" controls preload="auto"></video>
        <button onclick="enterVRMode()">Enter VR Mode</button>
    </div>
    <a-scene id="vrScene" vr-mode-ui="enabled: true" embedded style="display: none;">
        <a-videosphere
            id="videoSphere"
            src="https://storage.googleapis.com/vrvideo1/video1/VR%20360%20The%20Beast%20World's%20Longest%20Wooden%20Roller%20Coaster%20POV%20Kings%20Island%20Ohio.mp4"
            rotation="0 180 0"
            autoplay="true"
            loop="true"
            crossOrigin="anonymous">
        </a-videosphere>
        <a-entity camera lookcontrols position="0 0 0"></a-entity>
        <div class="vrControls">
            <button id="toggleControlsButton" class="clickable">Show Controls</button>
            <div id="controlsPanel">
                <div class="controls-header">
                    <h3 class="controls-title">Video Controls</h3>
                    <button class="close-controls" id="closeControls">×</button>
                </div>
                <div class="control-group">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-bar-fill" id="progressFill"></div>
                    </div>
                    <div class="time-display">
                        <span id="currentTime">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">Volume</div>
                    <div class="volume-control">
                        <button class="control-button" id="muteButton">🔊</button>
                        <div class="volume-slider">
                            <div class="volume-fill" id="volumeFill"></div>
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">Playback Speed</div>
                    <select class="speed-select" id="speedSelect">
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                </div>
                <div class="control-group">
                    <div class="control-label">Quality</div>
                    <select class="quality-select" id="qualitySelect">
                        <option value="auto">Auto</option>
                        <option value="1080p">1080p</option>
                        <option value="720p">720p</option>
                        <option value="480p">480p</option>
                        <option value="360p">360p</option>
                    </select>
                </div>
                <div class="control-group">
                    <button id="playPauseButton" class="clickable">Play/Pause Video</button>
                    <button id="recenterButton" class="clickable">Recenter VR</button>
                </div>
            </div>
            <div class="quick-controls" id="quickControls">
                <button class="quick-control-button" id="quickPlayPause">▶️</button>
                <button class="quick-control-button" id="quickMute">🔊</button>
                <button class="quick-control-button" id="quickRecenter">🔄</button>
            </div>
        </div>
    </a-scene>
    <div id="error-message"></div>

    <script>
        var videoElement;
        var isVRMode = false;
        let controlsTimeout;
        let isMuted = false;
        let lastVolume = 1;

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function startVR() {
            const scene = document.querySelector('a-scene');
            if (scene) {
                scene.enterVR();
                document.body.classList.add('vr-mode');
                isVRMode = true;
            } else {
                console.error('A-Frame scene not found');
            }
        }

        function enterVRMode() {
            document.querySelector('.initialUI').style.display = 'none';
            document.getElementById('vrScene').style.display = 'block';
            startVR();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const videoSphere = document.querySelector('#videoSphere');
            const errorMessage = document.getElementById('error-message');
            const toggleControlsButton = document.getElementById('toggleControlsButton');
            const controlsPanel = document.getElementById('controlsPanel');
            const playPauseButton = document.getElementById('playPauseButton');
            const recenterButton = document.getElementById('recenterButton');
            const smallVideoPlayer = document.getElementById('smallVideoPlayer');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const currentTimeDisplay = document.getElementById('currentTime');
            const durationDisplay = document.getElementById('duration');
            const muteButton = document.getElementById('muteButton');
            const volumeSlider = document.querySelector('.volume-slider');
            const volumeFill = document.getElementById('volumeFill');
            const speedSelect = document.getElementById('speedSelect');
            const qualitySelect = document.getElementById('qualitySelect');
            const closeControls = document.getElementById('closeControls');
            const quickControls = document.getElementById('quickControls');
            const quickPlayPause = document.getElementById('quickPlayPause');
            const quickMute = document.getElementById('quickMute');
            const quickRecenter = document.getElementById('quickRecenter');

            // Preload video
            smallVideoPlayer.load();

            if (!videoSphere) {
                console.error('Video sphere element not found');
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Error: Video sphere not found';
                return;
            }

            const scene = document.getElementById('vrScene');
            scene.addEventListener('loaded', () => {
                videoSphere.addEventListener('loaded', () => {
                    videoElement = videoSphere.components.material?.material?.map?.image;

                    if (!videoElement) {
                        console.error('Video element not found in videosphere');
                        errorMessage.style.display = 'block';
                        errorMessage.textContent = 'Error: Video element not found';
                        return;
                    }

                    // Set up play/pause button
                    function updateButtonState() {
                        if (videoElement.paused) {
                            playPauseButton.textContent = 'Play Video';
                        } else {
                            playPauseButton.textContent = 'Pause Video';
                        }
                    }

                    videoElement.addEventListener('play', updateButtonState);
                    videoElement.addEventListener('pause', updateButtonState);
                    updateButtonState();

                    playPauseButton.addEventListener('click', function() {
                        if (videoElement.paused) {
                            videoElement.play().catch(e => {
                                console.error('Error playing video:', e);
                                errorMessage.style.display = 'block';
                                errorMessage.textContent = 'Error playing video. Please try again.';
                            });
                        } else {
                            videoElement.pause();
                        }
                    });

                    // Set up recenter button
                    recenterButton.addEventListener('click', function() {
                        const camera = document.querySelector('a-entity[camera]');
                        if (camera) {
                            camera.setAttribute('lookcontrols', 'enabled: false');
                            camera.setAttribute('rotation', '0 0 0');
                            camera.setAttribute('lookcontrols', 'enabled: true');
                        } else {
                            console.error('Camera entity not found');
                        }
                    });

                    // Handle VR mode and controls
                    scene.addEventListener('enter-vr', () => {
                        toggleControlsButton.style.display = 'block';
                        // Show cursor in VR mode
                        const cursor = document.createElement('a-cursor');
                        cursor.setAttribute('id', 'vrCursor');
                        cursor.setAttribute('raycaster', 'objects: .clickable');
                        cursor.setAttribute('fuse', 'false');
                        cursor.setAttribute('fuse-timeout', '0');
                        scene.appendChild(cursor);
                    });

                    scene.addEventListener('exit-vr', () => {
                        toggleControlsButton.style.display = 'none';
                        controlsPanel.style.display = 'none';
                        const cursor = document.getElementById('vrCursor');
                        if (cursor) cursor.remove();
                        isVRMode = false;
                    });

                    toggleControlsButton.addEventListener('click', function() {
                        controlsPanel.style.display = controlsPanel.style.display === 'none' ? 'block' : 'none';
                    });

                    // Make buttons clickable in VR
                    playPauseButton.classList.add('clickable');
                    recenterButton.classList.add('clickable');
                    toggleControlsButton.classList.add('clickable');

                    // Video loaded successfully
                    videoElement.addEventListener('loadeddata', () => {
                        console.log('Video loaded successfully');
                        if (isMobile()) {
                            startVR();
                        }
                    });

                    // Video load error
                    videoElement.addEventListener('error', (e) => {
                        errorMessage.style.display = 'block';
                        errorMessage.textContent = 'Error loading video. Please check your connection and try again.';
                        console.error('Video load error:', e);
                    });

                    // Handle orientation change
                    window.addEventListener('orientationchange', () => {
                        if (isVRMode) {
                            controlsPanel.style.display = 'none';
                        }
                    });

                    // Format time in MM:SS
                    function formatTime(seconds) {
                        const minutes = Math.floor(seconds / 60);
                        seconds = Math.floor(seconds % 60);
                        return `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }

                    // Update progress bar
                    function updateProgress() {
                        if (videoElement) {
                            const progress = (videoElement.currentTime / videoElement.duration) * 100;
                            progressFill.style.width = `${progress}%`;
                            currentTimeDisplay.textContent = formatTime(videoElement.currentTime);
                            durationDisplay.textContent = formatTime(videoElement.duration);
                        }
                    }

                    // Handle progress bar click
                    progressBar.addEventListener('click', (e) => {
                        if (videoElement) {
                            const rect = progressBar.getBoundingClientRect();
                            const pos = (e.clientX - rect.left) / rect.width;
                            videoElement.currentTime = pos * videoElement.duration;
                        }
                    });

                    // Handle volume control
                    function updateVolume(volume) {
                        if (videoElement) {
                            videoElement.volume = volume;
                            volumeFill.style.width = `${volume * 100}%`;
                            muteButton.textContent = volume === 0 ? '🔇' : '🔊';
                        }
                    }

                    volumeSlider.addEventListener('click', (e) => {
                        const rect = volumeSlider.getBoundingClientRect();
                        const volume = (e.clientX - rect.left) / rect.width;
                        updateVolume(Math.max(0, Math.min(1, volume)));
                    });

                    // Handle mute toggle
                    function toggleMute() {
                        if (videoElement) {
                            if (isMuted) {
                                videoElement.volume = lastVolume;
                                muteButton.textContent = '🔊';
                                quickMute.textContent = '🔊';
                            } else {
                                lastVolume = videoElement.volume;
                                videoElement.volume = 0;
                                muteButton.textContent = '🔇';
                                quickMute.textContent = '🔇';
                            }
                            isMuted = !isMuted;
                        }
                    }

                    muteButton.addEventListener('click', toggleMute);
                    quickMute.addEventListener('click', toggleMute);

                    // Handle playback speed
                    speedSelect.addEventListener('change', (e) => {
                        if (videoElement) {
                            videoElement.playbackRate = parseFloat(e.target.value);
                        }
                    });

                    // Handle quality selection
                    qualitySelect.addEventListener('change', (e) => {
                        // Implement quality change logic here
                        console.log('Quality changed to:', e.target.value);
                    });

                    // Handle quick controls
                    quickPlayPause.addEventListener('click', () => {
                        if (videoElement) {
                            if (videoElement.paused) {
                                videoElement.play();
                                quickPlayPause.textContent = '⏸️';
                            } else {
                                videoElement.pause();
                                quickPlayPause.textContent = '▶️';
                            }
                        }
                    });

                    quickRecenter.addEventListener('click', () => {
                        const camera = document.querySelector('a-entity[camera]');
                        if (camera) {
                            camera.setAttribute('lookcontrols', 'enabled: false');
                            camera.setAttribute('rotation', '0 0 0');
                            camera.setAttribute('lookcontrols', 'enabled: true');
                        }
                    });

                    // Show/hide controls on movement
                    function showControls() {
                        controlsPanel.style.display = 'block';
                        quickControls.classList.add('visible');
                        clearTimeout(controlsTimeout);
                        controlsTimeout = setTimeout(() => {
                            if (!controlsPanel.matches(':hover')) {
                                controlsPanel.style.display = 'none';
                                quickControls.classList.remove('visible');
                            }
                        }, 3000);
                    }

                    // Add movement detection
                    document.addEventListener('mousemove', showControls);
                    document.addEventListener('touchmove', showControls);

                    // Close controls button
                    closeControls.addEventListener('click', () => {
                        controlsPanel.style.display = 'none';
                    });

                    // Update quick controls state
                    videoElement.addEventListener('play', () => {
                        quickPlayPause.textContent = '⏸️';
                    });

                    videoElement.addEventListener('pause', () => {
                        quickPlayPause.textContent = '▶️';
                    });
                });
            });
        });
    </script>
</body>
</html>