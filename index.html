<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>VR Video Experience</title>
    <link rel="icon" type="image/x-icon" href="/VR-Research/favicon.ico">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #1e3a8a;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .ui-container {
            text-align: center;
            z-index: 1000;
            position: absolute;
            top: 20%;
            width: 100%;
        }
        .ui-container h1 {
            font-size: 1.5em;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgb(0 0 0 / 50%);
        }
        .ui-container button {
            background: #a78bfa;
            color: #fff;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0 4px 8px rgb(0 0 0 / 30%);
            transition: background 0.3s;
        }
        .ui-container button:not(:last-child) {
            margin-bottom: 10px;
        }
        .ui-container button:nth-child(2) {
            margin-top: 10px;
        }
        #controlsPanel {
            z-index: 1001;
            color: white;
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
        }
        #controlsPanel button {
            background: #a78bfa;
            color: #fff;
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: background 0.3s;
        }
        #controlsPanel button:hover {
            background: #8b5cf6;
        }
        .a-canvas {
            height: 100vh;
            width: 100vw;
        }
        #error-message {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #fff;
            z-index: 1001;
            display: none;
            background: rgb(0 0 0 / 70%);
            padding: 10px;
            border-radius: 5px;
        }
        /* Commented out to keep UI visible in VR mode */
        /* .vr-mode .ui-container {
            display: none;
        } */
    </style>
</head>
<body>
    <div class="ui-container">
        <h1>VR Video Experience</h1>
        <button onclick="startVR()">Enter VR Mode</button>
        <button id="toggleControlsButton" style="display: none;">Show Controls</button>
    </div>
    <div id="controlsPanel" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 5px;">
        <button id="playPauseButton" class="clickable">Play/Pause Video</button>
        <button id="recenterButton" class="clickable">Recenter VR</button>
    </div>
    <div id="error-message"></div>
    <a-scene vr-mode-ui="enabled: true" embedded>
        <a-videosphere
            id="videoSphere"
            src="https://storage.googleapis.com/vrvideo1/video1/VR%20360%20The%20Beast%20World's%20Longest%20Wooden%20Roller%20Coaster%20POV%20Kings%20Island%20Ohio.mp4"
            rotation="0 180 0"
            autoplay="true"
            loop="true"
            crossOrigin="anonymous">
        </a-videosphere>
        <a-entity camera look-controls position="0 0 0"></a-entity>
    </a-scene>

    <script>
        var videoElement;
        var isControlsVisible = false;

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function startVR() {
            const scene = document.querySelector('a-scene');
            if (scene) {
                scene.enterVR();
                document.body.classList.add('vr-mode');
            } else {
                console.error('A-Frame scene not found');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const videoSphere = document.querySelector('#videoSphere');
            const errorMessage = document.querySelector('#error-message');
            const toggleControlsButton = document.getElementById('toggleControlsButton');
            const controlsPanel = document.getElementById('controlsPanel');
            const playPauseButton = document.getElementById('playPauseButton');
            const recenterButton = document.getElementById('recenterButton');

            if (!videoSphere) {
                console.error('Video sphere element not found');
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Error: Video sphere not found';
                return;
            }

            const scene = document.querySelector('a-scene');
            scene.addEventListener('loaded', () => {
                videoSphere.addEventListener('loaded', () => {
                    videoElement = videoSphere.components.material?.material?.map?.image;

                    if (!videoElement) {
                        console.error('Video element not found in videosphere');
                        errorMessage.style.display = 'block';
                        errorMessage.textContent = 'Error: Video element not found';
                        return;
                    }

                    // Set up play/pause button
                    function updateButtonState() {
                        if (videoElement.paused) {
                            playPauseButton.textContent = 'Play Video';
                        } else {
                            playPauseButton.textContent = 'Pause Video';
                        }
                    }

                    videoElement.addEventListener('play', updateButtonState);
                    videoElement.addEventListener('pause', updateButtonState);
                    updateButtonState();

                    playPauseButton.addEventListener('click', function() {
                        if (videoElement.paused) {
                            videoElement.play();
                        } else {
                            videoElement.pause();
                        }
                    });

                    // Set up recenter button
                    recenterButton.addEventListener('click', function() {
                        const camera = document.querySelector('a-entity[camera]');
                        if (camera) {
                            camera.setAttribute('look-controls', 'enabled: false');
                            camera.setAttribute('rotation', '0 0 0');
                            camera.setAttribute('look-controls', 'enabled: true');
                        } else {
                            console.error('Camera entity not found');
                        }
                    });

                    // Handle VR mode and controls
                    scene.addEventListener('enter-vr', () => {
                        toggleControlsButton.style.display = 'block';
                        document.body.classList.add('vr-mode');
                        // Show cursor in VR mode
                        const cursor = document.createElement('a-cursor');
                        cursor.setAttribute('id', 'vrCursor');
                        cursor.setAttribute('raycaster', 'objects: .clickable');
                        scene.appendChild(cursor);
                    });

                    scene.addEventListener('exit-vr', () => {
                        toggleControlsButton.style.display = 'none';
                        controlsPanel.style.display = 'none';
                        isControlsVisible = false;
                        const cursor = document.getElementById('vrCursor');
                        if (cursor) cursor.remove();
                        document.body.classList.remove('vr-mode');
                    });

                    toggleControlsButton.addEventListener('click', function() {
                        isControlsVisible = !isControlsVisible;
                        controlsPanel.style.display = isControlsVisible ? 'block' : 'none';
                        toggleControlsButton.textContent = isControlsVisible ? 'Hide Controls' : 'Show Controls';
                    });

                    // Make buttons clickable in VR
                    playPauseButton.classList.add('clickable');
                    recenterButton.classList.add('clickable');
                    toggleControlsButton.classList.add('clickable');

                    // Video loaded successfully
                    videoElement.addEventListener('loadeddata', () => {
                        console.log('Video loaded successfully');
                        if (isMobile()) {
                            startVR();
                        }
                    });

                    // Video load error
                    videoElement.addEventListener('error', (e) => {
                        errorMessage.style.display = 'block';
                        errorMessage.textContent = 'Error loading video: ' + (e.message || 'Unknown error');
                        console.error('Video loading error:', e);
                    });

                    // Handle autoplay restrictions
                    videoElement.addEventListener('canplay', () => {
                        videoElement.play().catch((err) => {
                            errorMessage.style.display = 'block';
                            errorMessage.textContent = 'Tap screen to start video';
                            console.error('Autoplay failed:', err);
                            document.body.addEventListener('touchstart', function startVideo() {
                                videoElement.play();
                                document.body.removeEventListener('touchstart', startVideo);
                                errorMessage.style.display = 'none';
                                if (isMobile()) {
                                    startVR();
                                }
                            });
                        });
                    });
                });
            });
        });
    </script>
</body>
</html>